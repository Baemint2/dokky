<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mcp.semi.mypage.mapper.MyPageMapper">

	<resultMap id="MyPageMap" type="BoardDto">
	        <id property="boardNo" column="BOARD_NO"/>
	        <result property="boardTitle" column="BOARD_TITLE"/>
	        <result property="boardContent" column="BOARD_CONTENT"/>
	        <result property="boardHit" column="BOARD_HIT"/>
	        <result property="createDt" column="BOARD_CREATE_DT"/>
	        <association property="user" javaType="UserDto">
	            <id property="userNo" column="USER_NO"/>
	            <result property="userName" column="USER_NAME"/>
	        </association>
	        <collection property="comments" ofType="CommentDto">
	        	<id property="commentNo" column="CMT_NO"/>
	        	<result property="commentContent" column="CMT_CONTENT"/>
	        	<result property="createDt" column="CMT_CREATE_DT"/>
        		<association property="user" javaType="UserDto">
	         		   <id property="userNo" column="USER_NO"/>
	         		   <result property="userName" column="USER_NAME"/>
      	  	   </association>
	        </collection>
	</resultMap>
	
	<!-- 비밀번호 변경 -->
	<update id="modifyPw">
		UPDATE USER_T 
		SET USER_PW = #{newPw} 
		WHERE USER_NO = #{userNo} 
			AND USER_PW = #{originPw}
	</update>
	
	<!-- 계정 삭제: 탈퇴일 수정 -->
	<delete id="removeUser">
		UPDATE USER_T 
		SET WITHDRAWAL_DT = CURRENT_DATE
		WHERE USER_NO = #{userNo} 
			AND USER_PW = #{originPw}
	</delete>
	
	<!-- 계정 삭제: 데이터 삭제 -->
	<delete id="deleteUserData">
		DELETE FROM USER_T 
		WHERE CURRENT_DATE - WITHDRAWAL_DT >= 2
	</delete>
	
	<select id="getBoardsByUserNo" resultMap="MyPageMap">
		SELECT B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT, B.BOARD_HIT, B.BOARD_CREATE_DT, U.USER_NAME, U.USER_NO
		  FROM BOARD_T B
		 INNER JOIN USER_T U ON B.USER_NO = U.USER_NO
		 WHERE U.USER_NO = #{userNo}
		 ORDER BY B.BOARD_CREATE_DT DESC
	</select>
	
	<select id="getBoardsWithCommentsByUserNo" resultMap="MyPageMap">
		SELECT DISTINCT B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT, B.BOARD_HIT, B.BOARD_CREATE_DT, U.USER_NAME, U.USER_NO,
			   C.CMT_NO, C.CMT_CONTENT, C.CMT_CREATE_DT
	     FROM BOARD_T B
	    INNER JOIN USER_T U ON B.USER_NO = U.USER_NO
		 LEFT JOIN COMMENT_T C ON B.BOARD_NO = C.BOARD_NO
		WHERE B.USER_NO = #{userNo} AND CMT_NO IS NOT NULL
		ORDER BY B.BOARD_CREATE_DT DESC, C.CMT_CREATE_DT DESC
	</select>
	
</mapper>
